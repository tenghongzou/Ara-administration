# 後台管理系統 - 專案架構文檔

> 版本：2.0.0
> 最後更新：2024年12月

---

## 目錄

1. [專案概述](#專案概述)
2. [技術棧選擇](#技術棧選擇)
3. [目錄結構](#目錄結構)
4. [模組系統架構](#模組系統架構)
5. [功能模組](#功能模組)
6. [狀態管理方案](#狀態管理方案)
7. [路由結構設計](#路由結構設計)
8. [效能優化策略](#效能優化策略)
9. [安全性考量](#安全性考量)
10. [擴展性設計](#擴展性設計)

---

## 專案概述

本專案為企業級後台管理系統前端，採用現代化技術棧與國際大廠設計標準，旨在提供高效能、可擴展、易維護的管理介面解決方案。

### 設計理念

- **簡潔高效**：參考 Google Material Design 的簡潔理念
- **一致性體驗**：參考 Microsoft Fluent Design 的一致性原則
- **專業可靠**：參考 Stripe Dashboard 的專業設計風格
- **可存取性優先**：符合 WCAG 2.1 AA 標準

---

## 技術棧選擇

### 核心框架

| 技術 | 版本 | 用途 |
|------|------|------|
| SvelteKit | 2.x (Svelte 5) | 應用框架 |
| TypeScript | 5.x | 型別安全 |
| Tailwind CSS | 3.x | 樣式系統 |
| Vite | 5.x | 建置工具 |

### 輔助工具

| 工具 | 用途 |
|------|------|
| pnpm | 套件管理器 |
| Zod | 資料驗證 |
| Day.js | 日期處理 |
| Chart.js | 圖表視覺化 |
| Vitest | 單元測試 |
| Playwright | E2E 測試 |
| ESLint + Prettier | 程式碼品質 |

### 選擇理由

**為何選擇 SvelteKit 5？**

1. **編譯時優化**：Svelte 在編譯時將組件轉換為高效的原生 JavaScript，無需虛擬 DOM
2. **更小的打包體積**：相較於 React/Vue，產出的 bundle 更小
3. **Runes 響應式系統**：Svelte 5 的 Runes 提供更直觀的響應式語法
4. **SSG + SPA 混合**：SvelteKit 原生支援靜態生成與客戶端渲染混合模式
5. **開發者體驗**：簡潔的語法、更少的樣板程式碼

---

## 目錄結構

```
administration/
├── docs/                          # 開發文檔
│   ├── 01-專案架構文檔.md
│   ├── 02-開發規範指南.md
│   ├── 03-API整合規範.md
│   ├── 04-元件設計文檔.md
│   └── 05-部署與建置指南.md
│
├── src/
│   ├── lib/                       # 共用程式庫
│   │   ├── components/            # UI 元件
│   │   │   ├── ui/               # 基礎 UI 元件
│   │   │   │   ├── Button.svelte
│   │   │   │   ├── Input.svelte
│   │   │   │   ├── Modal.svelte
│   │   │   │   ├── Card.svelte
│   │   │   │   ├── Badge.svelte
│   │   │   │   └── index.ts
│   │   │   ├── layout/           # 佈局元件
│   │   │   │   ├── Sidebar.svelte
│   │   │   │   ├── Header.svelte
│   │   │   │   └── PageContainer.svelte
│   │   │   ├── forms/            # 表單元件
│   │   │   │   ├── Select.svelte
│   │   │   │   ├── Checkbox.svelte
│   │   │   │   └── DatePicker.svelte
│   │   │   └── charts/           # 圖表元件
│   │   │       ├── BarChart.svelte
│   │   │       └── PieChart.svelte
│   │   │
│   │   ├── modules/              # 功能模組（Feature Modules）
│   │   │   ├── index.ts          # 模組註冊中心
│   │   │   ├── types.ts          # 模組共用型別
│   │   │   │
│   │   │   ├── navigation/       # 導航配置模組
│   │   │   │   ├── config.ts     # 導航配置（從 layout 提取）
│   │   │   │   └── index.ts
│   │   │   │
│   │   │   ├── dashboard/        # 儀表板模組
│   │   │   │   ├── index.ts
│   │   │   │   ├── types.ts
│   │   │   │   ├── services/
│   │   │   │   │   └── dashboard.service.ts
│   │   │   │   └── components/
│   │   │   │       ├── StatsGrid.svelte
│   │   │   │       ├── ActivityFeed.svelte
│   │   │   │       ├── QuickActions.svelte
│   │   │   │       └── SubscriptionReminders.svelte
│   │   │   │
│   │   │   ├── notifications/    # 通知模組
│   │   │   │   ├── index.ts
│   │   │   │   ├── types.ts
│   │   │   │   ├── services/
│   │   │   │   │   └── notifications.service.ts
│   │   │   │   └── components/
│   │   │   │       ├── NotificationFilters.svelte
│   │   │   │       ├── NotificationItem.svelte
│   │   │   │       └── NotificationBatchActions.svelte
│   │   │   │
│   │   │   ├── logs/             # 日誌模組
│   │   │   │   ├── index.ts
│   │   │   │   ├── types.ts
│   │   │   │   ├── services/
│   │   │   │   │   ├── logs.service.ts
│   │   │   │   │   └── logs-export.ts
│   │   │   │   └── components/
│   │   │   │       ├── LogDetail.svelte
│   │   │   │       ├── LogFilters.svelte
│   │   │   │       ├── LogStats.svelte
│   │   │   │       └── LogExportDialog.svelte
│   │   │   │
│   │   │   └── account/          # 帳號模組
│   │   │       ├── index.ts
│   │   │       ├── types.ts
│   │   │       ├── services/
│   │   │       │   ├── profile.service.ts
│   │   │       │   ├── session.service.ts
│   │   │       │   ├── password.service.ts
│   │   │       │   └── two-factor.service.ts
│   │   │       └── components/
│   │   │           ├── AvatarUpload.svelte
│   │   │           ├── PasswordChangeModal.svelte
│   │   │           ├── SessionList.svelte
│   │   │           └── TwoFactorSetup.svelte
│   │   │
│   │   ├── stores/               # 狀態管理
│   │   │   ├── auth.ts           # 認證狀態
│   │   │   ├── ui.ts             # UI 狀態
│   │   │   ├── toast.ts          # 通知狀態
│   │   │   ├── notifications.ts  # 通知列表狀態
│   │   │   └── index.ts
│   │   │
│   │   ├── services/             # API 服務層
│   │   │   ├── core.ts           # API 核心工具
│   │   │   ├── auth/             # 認證 API
│   │   │   ├── users/            # 使用者 API
│   │   │   ├── subscriptions/    # 訂閱 API
│   │   │   ├── logs/             # 日誌 API
│   │   │   └── index.ts
│   │   │
│   │   ├── utils/                # 工具函式
│   │   ├── types/                # TypeScript 型別定義
│   │   └── constants/            # 常數定義
│   │
│   ├── routes/                   # 頁面路由
│   │   ├── (auth)/              # 認證頁面群組
│   │   │   ├── login/
│   │   │   └── forgot-password/
│   │   │
│   │   ├── (app)/               # 應用主體頁面群組
│   │   │   ├── +layout.svelte   # 使用 moduleRegistry 導航
│   │   │   ├── dashboard/
│   │   │   ├── subscriptions/
│   │   │   ├── notifications/
│   │   │   │   ├── +page.svelte
│   │   │   │   └── [id]/        # 通知詳情頁
│   │   │   │       └── +page.svelte
│   │   │   └── settings/
│   │   │       ├── profile/
│   │   │       ├── security/
│   │   │       └── logs/
│   │   │
│   │   └── +error.svelte
│   │
│   ├── app.html
│   ├── app.css
│   └── app.d.ts
│
├── static/
├── tests/
├── package.json
├── svelte.config.js
├── tailwind.config.js
├── tsconfig.json
└── vite.config.ts
```

---

## 模組系統架構

專案採用 Feature Module 架構，將功能按業務領域劃分為獨立模組，每個模組包含自己的類型、服務和元件。

### 模組註冊中心

```typescript
// src/lib/modules/index.ts
import { moduleRegistry } from '$lib/modules';

// 取得所有導航項目
const navItems = moduleRegistry.getAllNavItems();

// 取得特定模組配置
const dashboardModule = moduleRegistry.getModule('dashboard');
```

### 模組標準結構

每個模組遵循統一的目錄結構：

```
src/lib/modules/{module-name}/
├── index.ts                    # 模組導出和配置
├── types.ts                    # 類型定義
├── services/                   # 業務邏輯服務層
│   └── {feature}.service.ts
└── components/                 # 模組專屬元件
    └── {Component}.svelte
```

### 模組配置定義

```typescript
// 每個模組的 index.ts 導出 ModuleConfig
export const moduleConfig: ModuleConfig = {
  id: 'module-name',
  name: '模組名稱',
  description: '模組描述',
  basePath: '/base-path',
  navigation: [
    {
      id: 'nav-item',
      label: '導航標籤',
      href: '/path',
      icon: navIcons.iconName,
      order: 10  // 決定導航順序
    }
  ],
  enabled: true
};
```

---

## 功能模組

### 1. Dashboard 模組

儀表板數據展示和快捷操作模組。

```typescript
// 導入方式
import {
  dashboardService,
  StatsGrid,
  ActivityFeed,
  QuickActions,
  SubscriptionReminders
} from '$lib/modules/dashboard';
```

**服務層功能：**
- `dashboardService.formatStats()` - 格式化統計數據
- `dashboardService.formatActivity()` - 格式化活動記錄
- `dashboardService.formatCurrency()` - 貨幣格式化

**元件列表：**
| 元件 | 用途 |
|------|------|
| `StatsGrid` | 統計卡片網格 |
| `ActivityFeed` | 最近活動列表 |
| `QuickActions` | 快捷操作按鈕 |
| `SubscriptionReminders` | 訂閱到期提醒 |

### 2. Notifications 模組

通知管理模組，支援分類篩選、批量操作和詳情檢視。

```typescript
// 導入方式
import {
  notificationsService,
  NotificationList,
  NotificationFilters,
  NotificationDetail,
  NotificationBatchActions
} from '$lib/modules/notifications';
```

**功能特色：**
- 分類篩選 (security, system, subscription, user, info)
- 狀態篩選 (全部、已讀、未讀)
- 日期範圍篩選
- 搜尋功能
- 批量標記已讀/刪除
- 詳情頁面 (`/notifications/[id]`)

**服務層功能：**
- `notificationsService.filterNotifications()` - 多條件篩選
- `notificationsService.markAsRead()` - 標記已讀
- `notificationsService.batchOperation()` - 批量操作

### 3. Logs 模組

系統日誌管理模組，支援進階搜尋、統計和導出。

```typescript
// 導入方式
import {
  logsService,
  logsExportService,
  LogDetail,
  LogFilters,
  LogStatsPanel,
  LogExportDialog
} from '$lib/modules/logs';
```

**功能特色：**
- 全文搜尋
- 進階篩選面板 (使用者、日期範圍、操作類型)
- 日誌詳情 Modal (顯示變更前後值)
- 統計圖表 (操作趨勢、類型分佈)
- 多格式導出 (CSV, JSON, Excel)

**服務層功能：**
- `logsService.filterLogs()` - 日誌篩選
- `logsService.formatLogEntry()` - 日誌格式化
- `logsService.getStatistics()` - 統計數據
- `logsExportService.exportToCSV()` - CSV 導出
- `logsExportService.exportToJSON()` - JSON 導出
- `logsExportService.exportToExcel()` - Excel 導出

### 4. Account 模組

帳號設定模組，包含個人資料、密碼管理、2FA 和登入 Session 管理。

```typescript
// 導入方式
import {
  profileService,
  sessionService,
  twoFactorService,
  passwordService,
  AvatarUpload,
  PasswordChangeModal,
  SessionList,
  TwoFactorSetupModal
} from '$lib/modules/account';
```

**服務層功能：**

| 服務 | 功能 |
|------|------|
| `profileService` | 個人資料驗證與更新 |
| `passwordService` | 密碼強度驗證、變更處理 |
| `sessionService` | 登入裝置管理、撤銷 Session |
| `twoFactorService` | 2FA 設定、驗證、備份碼管理 |

**元件列表：**
| 元件 | 用途 |
|------|------|
| `AvatarUpload` | 頭像上傳與預覽 |
| `PasswordChangeModal` | 密碼變更對話框 |
| `SessionList` | 登入裝置列表 |
| `TwoFactorSetupModal` | 2FA 設定精靈 |

---

## 認證模組 (Authentication)

認證模組位於 `src/lib/services/auth/`，處理使用者身份驗證相關功能：

```typescript
// 功能範圍
- 使用者登入/登出
- JWT Token 管理
- 密碼重設
- Session 管理
- 權限驗證
```

---

## 通用模組 (Common)

通用功能和元件位於 `src/lib/` 根目錄：

```typescript
// 功能範圍
- UI 元件庫 (src/lib/components/ui/)
- 工具函式 (src/lib/utils/)
- API 服務層 (src/lib/services/)
- 狀態管理 (src/lib/stores/)
```

---

## 狀態管理方案

採用 Svelte 5 的 Runes 搭配 Stores 進行狀態管理：

### 全域狀態設計

```typescript
// src/lib/stores/auth.ts
import { writable, derived } from 'svelte/store';
import type { User } from '$lib/types';

interface AuthState {
  user: User | null;
  token: string | null;
  isLoading: boolean;
  error: string | null;
}

const initialState: AuthState = {
  user: null,
  token: null,
  isLoading: false,
  error: null
};

function createAuthStore() {
  const { subscribe, set, update } = writable<AuthState>(initialState);

  return {
    subscribe,
    setUser: (user: User, token: string) => {
      update(state => ({ ...state, user, token, error: null }));
    },
    logout: () => set(initialState),
    setLoading: (isLoading: boolean) => {
      update(state => ({ ...state, isLoading }));
    },
    setError: (error: string) => {
      update(state => ({ ...state, error, isLoading: false }));
    }
  };
}

export const auth = createAuthStore();

// 衍生狀態
export const isAuthenticated = derived(auth, $auth => !!$auth.token);
export const currentUser = derived(auth, $auth => $auth.user);
```

### UI 狀態管理

```typescript
// src/lib/stores/ui.ts
import { writable } from 'svelte/store';

interface UIState {
  sidebarOpen: boolean;
  theme: 'light' | 'dark' | 'system';
  locale: string;
}

function createUIStore() {
  const { subscribe, update } = writable<UIState>({
    sidebarOpen: true,
    theme: 'system',
    locale: 'zh-TW'
  });

  return {
    subscribe,
    toggleSidebar: () => {
      update(state => ({ ...state, sidebarOpen: !state.sidebarOpen }));
    },
    setTheme: (theme: UIState['theme']) => {
      update(state => ({ ...state, theme }));
    }
  };
}

export const ui = createUIStore();
```

### 使用 Svelte 5 Runes（組件內狀態）

```svelte
<script lang="ts">
  // 響應式狀態
  let count = $state(0);

  // 衍生狀態
  let doubled = $derived(count * 2);

  // 副作用
  $effect(() => {
    console.log(`Count changed to ${count}`);
  });
</script>
```

---

## 路由結構設計

### 路由群組

| 群組 | 路徑 | 說明 |
|------|------|------|
| (auth) | `/login`, `/forgot-password` | 認證相關，無需登入 |
| (app) | `/dashboard`, `/users`, `/settings` | 應用主體，需要登入 |

### 完整路由表

```
/                           → 重導向至 /dashboard
├── /login                  → 登入頁面
├── /forgot-password        → 忘記密碼
│
├── /dashboard              → 儀表板首頁
│
├── /users                  → 使用者列表
├── /users/create           → 新增使用者
├── /users/[id]             → 使用者詳情/編輯
│
├── /settings               → 設定首頁
├── /settings/profile       → 個人資料
├── /settings/security      → 安全設定
│
└── /*                      → 404 頁面
```

### 路由守衛實作

```typescript
// src/routes/(app)/+layout.ts
import { redirect } from '@sveltejs/kit';
import type { LayoutLoad } from './$types';
import { browser } from '$app/environment';

export const load: LayoutLoad = async ({ parent }) => {
  if (browser) {
    const token = localStorage.getItem('token');
    if (!token) {
      throw redirect(302, '/login');
    }
  }

  return await parent();
};
```

---

## 效能優化策略

### 1. 程式碼分割

```typescript
// svelte.config.js
export default {
  kit: {
    // 自動程式碼分割
    prerender: {
      handleMissingId: 'warn'
    }
  }
};
```

### 2. 圖片優化

```svelte
<!-- 使用 enhanced:img -->
<enhanced:img src="./image.png" alt="描述" />
```

### 3. 預載入策略

```svelte
<!-- 滑鼠懸停時預載入 -->
<a href="/users" data-sveltekit-preload-data="hover">
  使用者管理
</a>
```

### 4. 虛擬列表（大量資料）

```typescript
// 使用 svelte-virtual-list 處理大量資料
import VirtualList from 'svelte-virtual-list';
```

### 5. 快取策略

```typescript
// 實作請求快取
const cache = new Map();

async function fetchWithCache(url: string, ttl = 60000) {
  const cached = cache.get(url);
  if (cached && Date.now() - cached.timestamp < ttl) {
    return cached.data;
  }

  const response = await fetch(url);
  const data = await response.json();
  cache.set(url, { data, timestamp: Date.now() });
  return data;
}
```

---

## 安全性考量

### 1. 認證與授權

```typescript
// JWT Token 處理
- Access Token 存放於記憶體
- Refresh Token 使用 HttpOnly Cookie
- Token 自動刷新機制
```

### 2. XSS 防護

```typescript
// Svelte 自動轉義輸出
// 避免使用 {@html} 除非必要
{@html sanitizedContent} // 使用 DOMPurify 清理
```

### 3. CSRF 防護

```typescript
// 所有 POST 請求攜帶 CSRF Token
headers: {
  'X-CSRF-Token': csrfToken
}
```

### 4. 內容安全政策 (CSP)

```html
<meta http-equiv="Content-Security-Policy"
      content="default-src 'self'; script-src 'self';">
```

---

## 擴展性設計

### 1. 插件系統預留

```typescript
// src/lib/plugins/index.ts
interface Plugin {
  name: string;
  install: (app: App) => void;
}

export function registerPlugin(plugin: Plugin) {
  plugins.push(plugin);
}
```

### 2. 模組動態載入

```typescript
// 按需載入模組
const UserModule = await import('./modules/user');
```

### 3. 主題擴展

```typescript
// tailwind.config.js
module.exports = {
  theme: {
    extend: {
      colors: {
        primary: {
          // 可被覆蓋的主題色
        }
      }
    }
  }
};
```

### 4. 多語系支援預留

```typescript
// 國際化架構預留
const i18n = {
  'zh-TW': () => import('./locales/zh-TW.json'),
  'en-US': () => import('./locales/en-US.json')
};
```

---

## 附錄

### 相關文檔連結

- [02-開發規範指南](./02-開發規範指南.md)
- [03-API整合規範](./03-API整合規範.md)
- [04-元件設計文檔](./04-元件設計文檔.md)
- [05-部署與建置指南](./05-部署與建置指南.md)

### 參考資源

- [SvelteKit 官方文檔](https://kit.svelte.dev/)
- [Svelte 5 文檔](https://svelte.dev/)
- [Tailwind CSS 文檔](https://tailwindcss.com/)
- [TypeScript 手冊](https://www.typescriptlang.org/docs/)
